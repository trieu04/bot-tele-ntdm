'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var extend = require('extend');

var abind = require('abind');

var isArrayKey = require('./key/is_array_key');

var fromArrayKey = require('./key/from_array_key');

var toArrayKey = require('./key/to_array_key');

var isRecursive = function isRecursive(value) {
  if (!value) {
    return false;
  }

  var reservedClasses = [Date];
  var isReservedClass = reservedClasses.some(function (C) {
    return value instanceof C;
  });

  if (isReservedClass) {
    return false;
  }

  switch ((0, _typeof2["default"])(value)) {
    case 'string':
    case 'number':
    case 'boolean':
    case 'function':
      return false;

    default:
      return true;
  }
};
/**
 * @memberOf module:objnest
 * @class Objnest
 * @param {object} config
 */


function Objnest(config) {
  Object.assign(this, config);
  abind(this);
}

Objnest.prototype = {
  separator: '.',

  /**
   * @function expand
   * @param {object} object - Obj to flatten
   * @returns {object} Flatten obj.
   * @example
   *  const obj = objnest.expand({
   *      'foo.bar': 'baz'
   *  })
   *  console.log(obj) // => {foo: {bar: 'baz'}}
   */
  expand: function expand(object) {
    var _this = this;

    if (Array.isArray(object)) {
      return object.map(function (object) {
        return _this.expand(object);
      });
    }

    if (!isRecursive(object)) {
      return object;
    }

    var separator = this.separator;
    var result = {};

    for (var _i = 0, _Object$keys = Object.keys(object); _i < _Object$keys.length; _i++) {
      var key = _Object$keys[_i];
      var val = object[key];
      var needsSeparate = !!~key.indexOf(separator);

      if (needsSeparate) {
        var subKeys = key.split(separator);
        var firstSubKey = subKeys[0];

        if (firstSubKey === '__proto__' || firstSubKey === 'prototype' || firstSubKey === 'constructor') {
          continue;
        }

        var subObj = {};
        var thisKey = subKeys.shift();
        subObj[subKeys.join('.')] = val;
        var subExpandedObj = this.expand(subObj);
        var thisVal = result[thisKey];
        val = this._merge(thisVal, subExpandedObj);
        key = thisKey;
      }

      if (isArrayKey(key)) {
        var arrayKey = fromArrayKey(key);

        if (!result[arrayKey.name]) {
          var length = object["".concat(arrayKey.name, "[length]")] || 0;
          result[arrayKey.name] = new Array(length);
        }

        if (arrayKey.index !== null) {
          result[arrayKey.name][arrayKey.index] = this._merge(result[arrayKey.name][arrayKey.index], val);
        }
      } else {
        result[key] = val;
      }
    }

    return result;
  },

  /**
   * Flatten nested object.
   * @param {object} nested - Object to flatten.
   * @param {Object} [options={}]
   * @returns {object} - Flattened object.
   * @example
   *  const flattened = objnest.flatten({
   *      'foo': {'bar': 'baz'}
   *  })
   *  console.log(flattened) // => {'foo.bar': 'baz'}
   */
  flatten: function flatten(nested) {
    var _this2 = this;

    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    var parent = options.parent;

    if (!isRecursive(nested)) {
      return nested;
    }

    var topLevelArray = Array.isArray(nested) && !parent;

    if (topLevelArray) {
      return nested.map(function (v) {
        return _this2.flatten(v);
      });
    }

    var separator = this.separator;
    var flattened = {};

    for (var _i2 = 0, _Object$keys2 = Object.keys(nested || {}); _i2 < _Object$keys2.length; _i2++) {
      var key = _Object$keys2[_i2];
      var value = nested[key];

      if (value === null) {
        flattened[key] = value;
        continue;
      }

      if (isRecursive(value)) {
        var subValues = this.flatten(value, {
          parent: nested
        });
        var isArray = Array.isArray(value);

        if (isArray) {
          flattened["".concat(key, "[length]")] = value.length;
        }

        for (var _i3 = 0, _Object$keys3 = Object.keys(subValues); _i3 < _Object$keys3.length; _i3++) {
          var subKey = _Object$keys3[_i3];
          var fullKey = void 0;

          if (isArray) {
            fullKey = key + toArrayKey(subKey);
          } else {
            fullKey = [key, subKey].join(separator);
          }

          flattened[fullKey] = subValues[subKey];
        }
      } else {
        flattened[key] = value;
      }
    }

    return flattened;
  },
  _merge: function _merge(v1, v2) {
    if (typeof v1 === 'undefined') {
      return v2;
    }

    if (typeof v2 === 'undefined') {
      return v1;
    }

    return extend(true, v1, v2 || {});
  }
};
module.exports = Objnest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9iam5lc3QuanMiXSwibmFtZXMiOlsiZXh0ZW5kIiwicmVxdWlyZSIsImFiaW5kIiwiaXNBcnJheUtleSIsImZyb21BcnJheUtleSIsInRvQXJyYXlLZXkiLCJpc1JlY3Vyc2l2ZSIsInZhbHVlIiwicmVzZXJ2ZWRDbGFzc2VzIiwiRGF0ZSIsImlzUmVzZXJ2ZWRDbGFzcyIsInNvbWUiLCJDIiwiT2JqbmVzdCIsImNvbmZpZyIsIk9iamVjdCIsImFzc2lnbiIsInByb3RvdHlwZSIsInNlcGFyYXRvciIsImV4cGFuZCIsIm9iamVjdCIsIkFycmF5IiwiaXNBcnJheSIsIm1hcCIsInJlc3VsdCIsImtleXMiLCJrZXkiLCJ2YWwiLCJuZWVkc1NlcGFyYXRlIiwiaW5kZXhPZiIsInN1YktleXMiLCJzcGxpdCIsImZpcnN0U3ViS2V5Iiwic3ViT2JqIiwidGhpc0tleSIsInNoaWZ0Iiwiam9pbiIsInN1YkV4cGFuZGVkT2JqIiwidGhpc1ZhbCIsIl9tZXJnZSIsImFycmF5S2V5IiwibmFtZSIsImxlbmd0aCIsImluZGV4IiwiZmxhdHRlbiIsIm5lc3RlZCIsIm9wdGlvbnMiLCJwYXJlbnQiLCJ0b3BMZXZlbEFycmF5IiwidiIsImZsYXR0ZW5lZCIsInN1YlZhbHVlcyIsInN1YktleSIsImZ1bGxLZXkiLCJ2MSIsInYyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBQ0EsSUFBTUMsS0FBSyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxJQUFNRSxVQUFVLEdBQUdGLE9BQU8sQ0FBQyxvQkFBRCxDQUExQjs7QUFDQSxJQUFNRyxZQUFZLEdBQUdILE9BQU8sQ0FBQyxzQkFBRCxDQUE1Qjs7QUFDQSxJQUFNSSxVQUFVLEdBQUdKLE9BQU8sQ0FBQyxvQkFBRCxDQUExQjs7QUFFQSxJQUFNSyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFDQyxL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QixDQUFWO0FBQ0Q7O0FBQ0RnQyxVQUFBQSxTQUFTLENBQUNHLE9BQUQsQ0FBVCxHQUFxQkYsU0FBUyxDQUFDQyxNQUFELENBQTlCO0FBQ0Q7QUFDRixPQWZELE1BZU87QUFDTEYsUUFBQUEsU0FBUyxDQUFDeEIsR0FBRCxDQUFULEdBQWlCbkIsS0FBakI7QUFDRDtBQUNGOztBQUNELFdBQU8yQyxTQUFQO0FBQ0QsR0F4R2lCO0FBeUdsQlgsRUFBQUEsTUF6R2tCLGtCQXlHVmUsRUF6R1UsRUF5R05DLEVBekdNLEVBeUdGO0FBQ2QsUUFBSSxPQUFPRCxFQUFQLEtBQWMsV0FBbEIsRUFBK0I7QUFDN0IsYUFBT0MsRUFBUDtBQUNEOztBQUNELFFBQUksT0FBT0EsRUFBUCxLQUFjLFdBQWxCLEVBQStCO0FBQzdCLGFBQU9ELEVBQVA7QUFDRDs7QUFDRCxXQUFPdEQsTUFBTSxDQUFDLElBQUQsRUFBT3NELEVBQVAsRUFBV0MsRUFBRSxJQUFJLEVBQWpCLENBQWI7QUFDRDtBQWpIaUIsQ0FBcEI7QUFvSEFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjVDLE9BQWpCIiwic291cmNlUm9vdCI6Ii4uLy4uL2xpYiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBleHRlbmQgPSByZXF1aXJlKCdleHRlbmQnKVxuY29uc3QgYWJpbmQgPSByZXF1aXJlKCdhYmluZCcpXG5jb25zdCBpc0FycmF5S2V5ID0gcmVxdWlyZSgnLi9rZXkvaXNfYXJyYXlfa2V5JylcbmNvbnN0IGZyb21BcnJheUtleSA9IHJlcXVpcmUoJy4va2V5L2Zyb21fYXJyYXlfa2V5JylcbmNvbnN0IHRvQXJyYXlLZXkgPSByZXF1aXJlKCcuL2tleS90b19hcnJheV9rZXknKVxuXG5jb25zdCBpc1JlY3Vyc2l2ZSA9ICh2YWx1ZSkgPT4ge1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgY29uc3QgcmVzZXJ2ZWRDbGFzc2VzID0gW0RhdGVdXG4gIGNvbnN0IGlzUmVzZXJ2ZWRDbGFzcyA9IHJlc2VydmVkQ2xhc3Nlcy5zb21lKChDKSA9PiB2YWx1ZSBpbnN0YW5jZW9mIEMpXG4gIGlmIChpc1Jlc2VydmVkQ2xhc3MpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkge1xuICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgY2FzZSAnbnVtYmVyJzpcbiAgICBjYXNlICdib29sZWFuJzpcbiAgICBjYXNlICdmdW5jdGlvbic6XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHRydWVcbiAgfVxufVxuXG4vKipcbiAqIEBtZW1iZXJPZiBtb2R1bGU6b2JqbmVzdFxuICogQGNsYXNzIE9iam5lc3RcbiAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWdcbiAqL1xuZnVuY3Rpb24gT2JqbmVzdCAoY29uZmlnKSB7XG4gIE9iamVjdC5hc3NpZ24odGhpcywgY29uZmlnKVxuICBhYmluZCh0aGlzKVxufVxuXG5PYmpuZXN0LnByb3RvdHlwZSA9IHtcbiAgc2VwYXJhdG9yOiAnLicsXG4gIC8qKlxuICAgKiBAZnVuY3Rpb24gZXhwYW5kXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgLSBPYmogdG8gZmxhdHRlblxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSBGbGF0dGVuIG9iai5cbiAgICogQGV4YW1wbGVcbiAgICogIGNvbnN0IG9iaiA9IG9iam5lc3QuZXhwYW5kKHtcbiAgICogICAgICAnZm9vLmJhcic6ICdiYXonXG4gICAqICB9KVxuICAgKiAgY29uc29sZS5sb2cob2JqKSAvLyA9PiB7Zm9vOiB7YmFyOiAnYmF6J319XG4gICAqL1xuICBleHBhbmQgKG9iamVjdCkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KG9iamVjdCkpIHtcbiAgICAgIHJldHVybiBvYmplY3QubWFwKChvYmplY3QpID0+IHRoaXMuZXhwYW5kKG9iamVjdCkpXG4gICAgfVxuICAgIGlmICghaXNSZWN1cnNpdmUob2JqZWN0KSkge1xuICAgICAgcmV0dXJuIG9iamVjdFxuICAgIH1cbiAgICBjb25zdCBzZXBhcmF0b3IgPSB0aGlzLnNlcGFyYXRvclxuICAgIGNvbnN0IHJlc3VsdCA9IHt9XG4gICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKG9iamVjdCkpIHtcbiAgICAgIGxldCB2YWwgPSBvYmplY3Rba2V5XVxuICAgICAgY29uc3QgbmVlZHNTZXBhcmF0ZSA9ICEhfmtleS5pbmRleE9mKHNlcGFyYXRvcilcbiAgICAgIGlmIChuZWVkc1NlcGFyYXRlKSB7XG4gICAgICAgIGNvbnN0IHN1YktleXMgPSBrZXkuc3BsaXQoc2VwYXJhdG9yKVxuICAgICAgICBjb25zdCBmaXJzdFN1YktleSA9IHN1YktleXNbMF1cbiAgICAgICAgaWYgKGZpcnN0U3ViS2V5ID09PSAnX19wcm90b19fJyB8fCBmaXJzdFN1YktleSA9PT0gJ3Byb3RvdHlwZScgfHwgZmlyc3RTdWJLZXkgPT09ICdjb25zdHJ1Y3RvcicpIHtcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN1Yk9iaiA9IHt9XG4gICAgICAgIGNvbnN0IHRoaXNLZXkgPSBzdWJLZXlzLnNoaWZ0KClcbiAgICAgICAgc3ViT2JqW3N1YktleXMuam9pbignLicpXSA9IHZhbFxuICAgICAgICBjb25zdCBzdWJFeHBhbmRlZE9iaiA9IHRoaXMuZXhwYW5kKHN1Yk9iailcbiAgICAgICAgY29uc3QgdGhpc1ZhbCA9IHJlc3VsdFt0aGlzS2V5XVxuICAgICAgICB2YWwgPSB0aGlzLl9tZXJnZSh0aGlzVmFsLCBzdWJFeHBhbmRlZE9iailcbiAgICAgICAga2V5ID0gdGhpc0tleVxuICAgICAgfVxuICAgICAgaWYgKGlzQXJyYXlLZXkoa2V5KSkge1xuICAgICAgICBjb25zdCBhcnJheUtleSA9IGZyb21BcnJheUtleShrZXkpXG4gICAgICAgIGlmICghcmVzdWx0W2FycmF5S2V5Lm5hbWVdKSB7XG4gICAgICAgICAgY29uc3QgbGVuZ3RoID0gb2JqZWN0W2Ake2FycmF5S2V5Lm5hbWV9W2xlbmd0aF1gXSB8fCAwXG4gICAgICAgICAgcmVzdWx0W2FycmF5S2V5Lm5hbWVdID0gbmV3IEFycmF5KGxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJyYXlLZXkuaW5kZXggIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHRbYXJyYXlLZXkubmFtZV1bYXJyYXlLZXkuaW5kZXhdID0gdGhpcy5fbWVyZ2UoXG4gICAgICAgICAgICByZXN1bHRbYXJyYXlLZXkubmFtZV1bYXJyYXlLZXkuaW5kZXhdLFxuICAgICAgICAgICAgdmFsXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRba2V5XSA9IHZhbFxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH0sXG4gIC8qKlxuICAgKiBGbGF0dGVuIG5lc3RlZCBvYmplY3QuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBuZXN0ZWQgLSBPYmplY3QgdG8gZmxhdHRlbi5cbiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XVxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSAtIEZsYXR0ZW5lZCBvYmplY3QuXG4gICAqIEBleGFtcGxlXG4gICAqICBjb25zdCBmbGF0dGVuZWQgPSBvYmpuZXN0LmZsYXR0ZW4oe1xuICAgKiAgICAgICdmb28nOiB7J2Jhcic6ICdiYXonfVxuICAgKiAgfSlcbiAgICogIGNvbnNvbGUubG9nKGZsYXR0ZW5lZCkgLy8gPT4geydmb28uYmFyJzogJ2Jheid9XG4gICAqL1xuICBmbGF0dGVuIChuZXN0ZWQsIG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHsgcGFyZW50IH0gPSBvcHRpb25zXG4gICAgaWYgKCFpc1JlY3Vyc2l2ZShuZXN0ZWQpKSB7XG4gICAgICByZXR1cm4gbmVzdGVkXG4gICAgfVxuICAgIGNvbnN0IHRvcExldmVsQXJyYXkgPSBBcnJheS5pc0FycmF5KG5lc3RlZCkgJiYgIXBhcmVudFxuICAgIGlmICh0b3BMZXZlbEFycmF5KSB7XG4gICAgICByZXR1cm4gbmVzdGVkLm1hcCgodikgPT4gdGhpcy5mbGF0dGVuKHYpKVxuICAgIH1cbiAgICBjb25zdCBzZXBhcmF0b3IgPSB0aGlzLnNlcGFyYXRvclxuICAgIGNvbnN0IGZsYXR0ZW5lZCA9IHt9XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMobmVzdGVkIHx8IHt9KSkge1xuICAgICAgY29uc3QgdmFsdWUgPSBuZXN0ZWRba2V5XVxuICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XG4gICAgICAgIGZsYXR0ZW5lZFtrZXldID0gdmFsdWVcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGlmIChpc1JlY3Vyc2l2ZSh2YWx1ZSkpIHtcbiAgICAgICAgY29uc3Qgc3ViVmFsdWVzID0gdGhpcy5mbGF0dGVuKHZhbHVlLCB7IHBhcmVudDogbmVzdGVkIH0pXG4gICAgICAgIGNvbnN0IGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KHZhbHVlKVxuICAgICAgICBpZiAoaXNBcnJheSkge1xuICAgICAgICAgIGZsYXR0ZW5lZFtgJHtrZXl9W2xlbmd0aF1gXSA9IHZhbHVlLmxlbmd0aFxuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3Qgc3ViS2V5IG9mIE9iamVjdC5rZXlzKHN1YlZhbHVlcykpIHtcbiAgICAgICAgICBsZXQgZnVsbEtleVxuICAgICAgICAgIGlmIChpc0FycmF5KSB7XG4gICAgICAgICAgICBmdWxsS2V5ID0ga2V5ICsgdG9BcnJheUtleShzdWJLZXkpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZ1bGxLZXkgPSBba2V5LCBzdWJLZXldLmpvaW4oc2VwYXJhdG9yKVxuICAgICAgICAgIH1cbiAgICAgICAgICBmbGF0dGVuZWRbZnVsbEtleV0gPSBzdWJWYWx1ZXNbc3ViS2V5XVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmbGF0dGVuZWRba2V5XSA9IHZhbHVlXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmbGF0dGVuZWRcbiAgfSxcbiAgX21lcmdlICh2MSwgdjIpIHtcbiAgICBpZiAodHlwZW9mIHYxID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIHYyXG4gICAgfVxuICAgIGlmICh0eXBlb2YgdjIgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICByZXR1cm4gdjFcbiAgICB9XG4gICAgcmV0dXJuIGV4dGVuZCh0cnVlLCB2MSwgdjIgfHwge30pXG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBPYmpuZXN0XG4iXX0=